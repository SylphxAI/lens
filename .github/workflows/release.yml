name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build all packages
        run: bun run build

      - name: Install bump CLI
        run: bun add -g @sylphx/bump

      - name: Configure npm
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine mode and run bump
        id: bump
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail

          LATEST_COMMIT_MSG=$(git log -1 --pretty=%s 2>/dev/null || echo "")

          # Check for release PR merge
          if [[ "$LATEST_COMMIT_MSG" == chore\(release\):* ]] || \
             [[ "$LATEST_COMMIT_MSG" == Merge*bump/release* ]]; then
            MODE="publish"
            echo "Detected release PR merge - switching to publish mode"
          else
            MODE="pr"
          fi
          echo "Auto-detected mode: $MODE"

          # PR mode - create/update release PR
          if [ "$MODE" = "pr" ]; then
            bump pr --base main
            echo "published=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Publish mode
          if [ "$MODE" = "publish" ]; then
            OUTPUT=$(bump publish 2>&1) || {
              echo "$OUTPUT"
              echo "published=false" >> $GITHUB_OUTPUT
              exit 1
            }
            echo "$OUTPUT"

            RESULT=$(echo "$OUTPUT" | grep -o '::bump-result::{.*}' | sed 's/::bump-result:://' || echo "")

            if [ -n "$RESULT" ]; then
              PUBLISHED=$(echo "$RESULT" | jq -r '.published')
              PACKAGES=$(echo "$RESULT" | jq -c '.packages')

              echo "published=$PUBLISHED" >> $GITHUB_OUTPUT

              if [ "$(echo "$PACKAGES" | jq 'length')" -gt "0" ]; then
                VERSIONS=$(echo "$PACKAGES" | jq -c 'map({(.name): .version}) | add')
                echo "versions=$VERSIONS" >> $GITHUB_OUTPUT
              fi
            else
              echo "published=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Notify on failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          [ -z "$SLACK_WEBHOOK" ] && exit 0
          NL=$'\n'
          MESSAGE="‚ùå *Release failed*${NL}Repository: ${{ github.repository }}${NL}<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
          curl -s -X POST "$SLACK_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg text "$MESSAGE" '{text: $text}')"
